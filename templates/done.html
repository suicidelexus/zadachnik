{% extends "base.html" %}

{% block title %}Завершённые задачи - Task Tracker{% endblock %}

{% block content %}
<div class="w-full">
<!-- Header - минималистичный -->
<div class="flex justify-between items-center mb-5 flex-wrap gap-3">
    <h1 class="text-2xl font-semibold text-base-content">Завершённые</h1>

    <button class="btn btn-ghost btn-sm text-error" onclick="deleteAllDoneTasks()">
        <span class="material-icons-round" style="font-size: 16px;">delete_sweep</span>
        <span class="ml-1">Удалить все</span>
    </button>
</div>

<div class="grid gap-3">
    <div id="doneTasksList" class="space-y-2">
        <!-- Задачи загружаются через JS -->
    </div>
</div>

</div><!-- Закрываем max-w wrapper -->
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadDoneTasks();
    });

    async function loadDoneTasks() {
        try {
            const response = await fetch('/api/tasks/done');
            const tasks = await response.json();

            const container = document.getElementById('doneTasksList');

            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-16 text-center">
                        <span class="material-icons-round text-6xl text-base-content/30 mb-4">task_alt</span>
                        <h3 class="text-xl font-bold text-base-content mb-2">Нет завершённых задач</h3>
                        <p class="text-base-content/60">Задачи со статусом "Done" будут отображаться здесь</p>
                    </div>
                `;
                return;
            }

            const priorityColors = {
                'low': 'badge-success',
                'medium': 'badge-warning',
                'high': 'badge-error',
                'highest': 'badge-secondary'
            };

            container.innerHTML = tasks.map(task => `
                <div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow border border-base-300" data-id="${task.id}">
                    <div class="card-body p-4">
                        <div class="flex justify-between items-start gap-4 cursor-pointer" onclick="openViewModal(${task.id})">
                            <div class="flex-1">
                                <div class="flex items-start justify-between gap-3 mb-2">
                                    <h4 class="card-title text-base">${task.title}</h4>
                                    <div class="badge ${priorityColors[task.priority.toLowerCase()]} badge-sm">${task.priority}</div>
                                </div>
                                ${task.description ? `<p class="text-sm text-base-content/70 mb-3">${task.description.substring(0, 150)}${task.description.length > 150 ? '...' : ''}</p>` : ''}
                                <div class="flex flex-wrap gap-2 items-center">
                                    ${task.tags.length > 0 ? task.tags.map(tag => `
                                        <span class="badge badge-outline badge-xs" style="border-color: ${tag.color}; color: ${tag.color}">${tag.name}</span>
                                    `).join('') : ''}
                                    ${task.executor ? `
                                        <div class="flex items-center gap-1 text-xs text-base-content/60">
                                            <span class="material-icons-round text-sm">person</span>
                                            <span>${task.executor}</span>
                                        </div>
                                    ` : ''}
                                    ${task.rice_score ? `
                                        <div class="badge badge-ghost badge-xs">
                                            <span class="material-icons-round text-xs mr-1">analytics</span>
                                            ${task.rice_score.toFixed(1)}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2 flex-shrink-0" onclick="event.stopPropagation()">
                                <button class="btn btn-ghost btn-sm flex items-center gap-1" onclick="restoreTask(${task.id})" title="Вернуть в работу">
                                    <span class="material-icons-round text-base">replay</span>
                                    <span>Вернуть</span>
                                </button>
                                <button class="btn btn-ghost btn-sm btn-circle text-error" onclick="deleteSingleTask(${task.id})" title="Удалить">
                                    <span class="material-icons-round">delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading done tasks:', error);
        }
    }

    async function restoreTask(taskId) {
        const status = prompt('Выберите новый статус:\n1 - New\n2 - Collecting\n3 - Ready for Dev\n4 - In Dev\n5 - Ready for Release', '1');

        const statusMap = {
            '1': 'New',
            '2': 'Collecting',
            '3': 'Ready for Dev',
            '4': 'In Dev',
            '5': 'Ready for Release'
        };

        const newStatus = statusMap[status];
        if (!newStatus) return;

        try {
            await fetch(`/api/tasks/${taskId}/restore`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            loadDoneTasks();
        } catch (error) {
            console.error('Error restoring task:', error);
        }
    }

    async function deleteSingleTask(taskId) {
        if (!confirm('Удалить эту задачу навсегда?')) return;

        try {
            await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
            loadDoneTasks();
        } catch (error) {
            console.error('Error deleting task:', error);
        }
    }

    async function deleteAllDoneTasks() {
        if (!confirm('Вы уверены, что хотите удалить ВСЕ завершённые задачи? Это действие нельзя отменить.')) return;

        try {
            await fetch('/api/tasks/done/delete-all', { method: 'DELETE' });
            loadDoneTasks();
        } catch (error) {
            console.error('Error deleting all done tasks:', error);
        }
    }
</script>
{% endblock %}
