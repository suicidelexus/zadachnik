{% extends "base.html" %}

{% block title %}–ì—Ä—É–ø–ø–∞ - Task Tracker{% endblock %}

{% block content %}
<div class="w-full">
<!-- Header -->
<div class="flex justify-between items-center mb-5 flex-wrap gap-3">
    <h1 class="text-2xl font-semibold text-base-content" id="groupTitle">
        <span id="groupIcon">üìÅ</span>
        <span id="groupName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </h1>

    <div class="flex gap-2 items-center flex-wrap">
        <button class="btn btn-primary btn-sm" onclick="openModal()">
            <span class="material-icons-round" style="font-size: 16px;">add</span>
            <span class="ml-1">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</span>
        </button>
    </div>
</div>

<!-- Kanban View -->
<div id="kanban-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 overflow-x-auto pb-4">
    <!-- Low Priority Column -->
    <div class="flex flex-col min-w-[300px]" data-priority="Low">
        <div class="bg-base-100 border-b-2 border-green-500 rounded-t-md p-3 flex justify-between items-center">
            <h3 class="text-base-content font-semibold text-sm">Low</h3>
            <div class="badge badge-ghost badge-sm" id="count-Low">0</div>
        </div>
        <div class="bg-base-100 border border-t-0 border-base-300 rounded-b-md p-3 min-h-[500px] space-y-3" id="tasks-Low"></div>
    </div>

    <!-- Medium Priority Column -->
    <div class="flex flex-col min-w-[300px]" data-priority="Medium">
        <div class="bg-base-100 border-b-2 border-yellow-500 rounded-t-md p-3 flex justify-between items-center">
            <h3 class="text-base-content font-semibold text-sm">Medium</h3>
            <div class="badge badge-ghost badge-sm" id="count-Medium">0</div>
        </div>
        <div class="bg-base-100 border border-t-0 border-base-300 rounded-b-md p-3 min-h-[500px] space-y-3" id="tasks-Medium"></div>
    </div>

    <!-- High Priority Column -->
    <div class="flex flex-col min-w-[300px]" data-priority="High">
        <div class="bg-base-100 border-b-2 border-red-500 rounded-t-md p-3 flex justify-between items-center">
            <h3 class="text-base-content font-semibold text-sm">High</h3>
            <div class="badge badge-ghost badge-sm" id="count-High">0</div>
        </div>
        <div class="bg-base-100 border border-t-0 border-base-300 rounded-b-md p-3 min-h-[500px] space-y-3" id="tasks-High"></div>
    </div>

    <!-- Highest Priority Column -->
    <div class="flex flex-col min-w-[300px]" data-priority="Highest">
        <div class="bg-base-100 border-b-2 border-purple-500 rounded-t-md p-3 flex justify-between items-center">
            <h3 class="text-base-content font-semibold text-sm">Highest</h3>
            <div class="badge badge-ghost badge-sm" id="count-Highest">0</div>
        </div>
        <div class="bg-base-100 border border-t-0 border-base-300 rounded-b-md p-3 min-h-[500px] space-y-3" id="tasks-Highest"></div>
    </div>
</div>
</div>

<script>
    const groupId = {{ group_id }};

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–ø–ø–µ
    async function loadGroup() {
        try {
            const response = await fetch(`/api/groups/${groupId}`);
            const group = await response.json();

            document.getElementById('groupIcon').textContent = group.icon || 'üìÅ';
            document.getElementById('groupName').textContent = group.name;
            document.title = `${group.name} - Task Tracker`;
        } catch (error) {
            console.error('Error loading group:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –≥—Ä—É–ø–ø—ã
    async function loadTasks() {
        try {
            const response = await fetch(`/api/groups/${groupId}/tasks`);
            const tasks = await response.json();

            renderKanbanView(tasks);
        } catch (error) {
            console.error('Error loading tasks:', error);
        }
    }

    function renderKanbanView(tasks) {
        // –û—á–∏—â–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
        ['Low', 'Medium', 'High', 'Highest'].forEach(priority => {
            document.getElementById(`tasks-${priority}`).innerHTML = '';
        });

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
        const grouped = {};
        tasks.forEach(task => {
            if (!grouped[task.priority]) {
                grouped[task.priority] = [];
            }
            grouped[task.priority].push(task);
        });

        // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∑–∞–¥–∞—á–∏
        ['Low', 'Medium', 'High', 'Highest'].forEach(priority => {
            const container = document.getElementById(`tasks-${priority}`);
            const priorityTasks = grouped[priority] || [];

            priorityTasks.forEach(task => {
                container.appendChild(createTaskCard(task));
            });
        });

        updateCounts();
    }

    function createTaskCard(task) {
        const card = document.createElement('div');
        card.className = 'card bg-base-100 shadow-md hover:shadow-xl transition-all cursor-pointer border border-base-300 mb-3';
        card.dataset.id = task.id;
        card.onclick = () => openViewModal(task.id);

        const statusClass = task.status.toLowerCase().replace(/ /g, '-');
        const statusBadgeClass = {
            'new': 'badge-info',
            'collecting': 'badge-warning',
            'ready-for-dev': 'badge-primary',
            'in-dev': 'badge-accent',
            'ready-for-release': 'badge-success'
        }[statusClass] || 'badge-ghost';

        card.innerHTML = `
            <div class="card-body p-4">
                <div class="flex justify-between items-start mb-2">
                    <div class="badge ${statusBadgeClass} badge-sm">${task.status}</div>
                    ${task.rice_score ? `<div class="badge badge-secondary badge-sm">
                        <span class="material-icons-round text-xs mr-1">analytics</span>
                        ${task.rice_score.toFixed(1)}
                    </div>` : ''}
                </div>

                <h4 class="card-title text-base font-semibold mb-2">${task.title}</h4>

                ${task.description ? `<p class="text-sm text-base-content/70 mb-3">${task.description.substring(0, 100)}${task.description.length > 100 ? '...' : ''}</p>` : ''}

                <div class="flex justify-between items-center flex-wrap gap-2">
                    <div class="flex gap-1.5 flex-wrap">
                        ${task.tags.map(tag => `<span class="badge badge-sm font-medium" style="background-color: ${tag.color}15; border: 1.5px solid ${tag.color}; color: ${tag.color}">${tag.emoji || ''} ${tag.name}</span>`).join('')}
                    </div>

                    ${task.executor ? `<div class="flex items-center gap-1 text-xs text-base-content/60">
                        <span class="material-icons-round text-sm">person</span>
                        <span>${task.executor}</span>
                    </div>` : ''}
                </div>
            </div>
        `;

        return card;
    }

    function updateCounts() {
        ['Low', 'Medium', 'High', 'Highest'].forEach(priority => {
            const count = document.getElementById(`tasks-${priority}`).children.length;
            document.getElementById(`count-${priority}`).textContent = count;
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadGroup();
        loadTasks();
    });
</script>
{% endblock %}
