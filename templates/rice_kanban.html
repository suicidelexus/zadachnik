{% extends "base.html" %}

{% block title %}Priority Score: –ü–æ –∫–∞–Ω–±–∞–Ω—É - Task Tracker{% endblock %}

{% block content %}
<div class="w-full">
<div class="mb-5">
    <h1 class="text-2xl font-semibold text-base-content mb-1">Priority Score: –ö–∞–Ω–±–∞–Ω</h1>
    <p class="text-sm text-base-content/60">–ó–∞–¥–∞—á–∏ –∏–∑ –ö–∞–Ω–±–∞–Ω–∞ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ Priority Score-–º–µ—Ç—Ä–∏–∫–∞–º–∏</p>
</div>

<div class="rice-info">
    <div class="rice-header-row">
        <div class="scoring-ranges">
            <h4>üìä –î–∏–∞–ø–∞–∑–æ–Ω—ã —Å–∫–æ—Ä–∏–Ω–≥–∞</h4>
            <div class="range-items">
                <div class="range-item range-high">
                    <span class="range-score">35‚Äì50</span>
                    <span class="material-icons-round range-icon">local_fire_department</span>
                    <span class="range-text">–ë–µ—Ä—ë–º –≤ —Ä–∞–±–æ—Ç—É</span>
                </div>
                <div class="range-item range-medium">
                    <span class="range-score">20‚Äì34</span>
                    <span class="material-icons-round range-icon">pending</span>
                    <span class="range-text">–ö–∞–Ω–¥–∏–¥–∞—Ç –≤ —Ä–∞–±–æ—Ç—É</span>
                </div>
                <div class="range-item range-low">
                    <span class="range-score">8‚Äì19</span>
                    <span class="material-icons-round range-icon">schedule</span>
                    <span class="range-text">–¢—Ä–µ–±—É–µ—Ç—Å—è Discovery</span>
                </div>
                <div class="range-item range-none">
                    <span class="range-score">0‚Äì7</span>
                    <span class="material-icons-round range-icon">remove_circle_outline</span>
                    <span class="range-text">–ù–µ –±–µ—Ä—ë–º –≤ —Ä–∞–±–æ—Ç—É</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="filters-bar">
    <div class="filter-group">
        <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
        <select id="filterPriority" onchange="loadRiceTasks()">
            <option value="">–í—Å–µ</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Highest">Highest</option>
        </select>
    </div>
    <div class="filter-group">
        <label>–°—Ç–∞—Ç—É—Å:</label>
        <select id="filterStatus" onchange="loadRiceTasks()">
            <option value="">–í—Å–µ</option>
            <option value="New">New</option>
            <option value="Collecting">Collecting</option>
            <option value="Ready for Dev">Ready for Dev</option>
            <option value="In Dev">In Dev</option>
            <option value="Ready for Release">Ready for Release</option>
        </select>
    </div>
</div>

<div class="rice-table-container">
    <table class="rice-table">
        <thead>
            <tr>
                <th>–ó–∞–¥–∞—á–∞</th>
                <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>Value</th>
                <th>Reach</th>
                <th>Budget</th>
                <th>Confidence</th>
                <th class="score-col">Priority Score</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="riceTableBody"></tbody>
    </table>
    <div id="emptyState" class="empty-state" style="display: none;">
        <span class="material-icons-round">analytics</span>
        <p>–ù–µ—Ç –∑–∞–¥–∞—á —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ Priority Score-–º–µ—Ç—Ä–∏–∫–∞–º–∏</p>
        <p class="empty-hint">–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É –≤ –ö–∞–Ω–±–∞–Ω–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ Priority Score-–º–µ—Ç—Ä–∏–∫–∏</p>
    </div>
</div>

</div><!-- –ó–∞–∫—Ä—ã–≤–∞–µ–º max-w wrapper -->
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadRiceTasks();
    });

    async function loadRiceTasks() {
        const priority = document.getElementById('filterPriority').value;
        const status = document.getElementById('filterStatus').value;

        let url = '/api/tasks-with-rice?';
        if (priority) url += `priority=${priority}&`;
        if (status) url += `status=${status}&`;

        try {
            const response = await fetch(url);
            let tasks = await response.json();

            const tbody = document.getElementById('riceTableBody');
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = '';

            if (tasks.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }
            emptyState.style.display = 'none';

            const priorityColors = {
                'low': 'badge-success',
                'medium': 'badge-warning',
                'high': 'badge-error',
                'highest': 'badge-secondary'
            };

            const statusColors = {
                'new': 'badge-info',
                'collecting': 'badge-warning',
                'ready-for-dev': 'badge-primary',
                'in-dev': 'badge-accent',
                'ready-for-release': 'badge-success'
            };

            tasks.forEach((task, index) => {
                const row = document.createElement('tr');
                const scoreClass = getScoreClass(task.rice_score);
                const statusKey = task.status.toLowerCase().replace(/ /g, '-');

                row.className = 'hover:bg-base-200 transition-colors';
                row.innerHTML = `
                    <td class="font-medium">
                        <div class="flex items-center gap-2">
                            <span class="badge badge-ghost badge-sm">#${index + 1}</span>
                            <a href="#" onclick="openViewModal(${task.id}); return false;" class="link link-hover text-primary">${task.title}</a>
                        </div>
                    </td>
                    <td><span class="badge ${priorityColors[task.priority.toLowerCase()]} badge-sm">${task.priority}</span></td>
                    <td><span class="badge ${statusColors[statusKey]} badge-sm">${task.status}</span></td>
                    <td>
                        <select class="select select-bordered select-xs w-20" onchange="updateRice(${task.id}, 'rice_value', this.value)">
                            <option value="">‚Äî</option>
                            ${[1,2,3,4,5].map(i =>
                                `<option value="${i}" ${task.rice_value === i ? 'selected' : ''}>${i}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <select class="select select-bordered select-xs w-20" onchange="updateRice(${task.id}, 'rice_reach', this.value)">
                            <option value="">‚Äî</option>
                            ${[1,2,3,4,5].map(i =>
                                `<option value="${i}" ${task.rice_reach === i ? 'selected' : ''}>${i}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <select class="select select-bordered select-xs w-20" onchange="updateRice(${task.id}, 'budget_impact', this.value)">
                            <option value="">‚Äî</option>
                            <option value="1.0" ${task.budget_impact === 1.0 || !task.budget_impact ? 'selected' : ''}>1.0</option>
                            <option value="1.2" ${task.budget_impact === 1.2 ? 'selected' : ''}>1.2</option>
                            <option value="1.5" ${task.budget_impact === 1.5 ? 'selected' : ''}>1.5</option>
                            <option value="2.0" ${task.budget_impact === 2.0 ? 'selected' : ''}>2.0</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" class="input input-bordered input-xs w-20" value="${task.rice_confidence ?? ''}"
                               onchange="updateRice(${task.id}, 'rice_confidence', this.value)"
                               min="0" max="100" placeholder="0-100">
                    </td>
                    <td>
                        <div class="badge ${scoreClass} badge-lg font-bold">
                            ${task.rice_score !== null ? task.rice_score.toFixed(2) : '‚Äî'}
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-ghost btn-sm btn-circle" onclick="openViewModal(${task.id})" title="–û—Ç–∫—Ä—ã—Ç—å">
                            <span class="material-icons-round text-base">open_in_new</span>
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading tasks:', error);
        }
    }

    function getScoreClass(score) {
        if (score === null || score === undefined) return 'badge-ghost';
        if (score >= 35) return 'badge-success';      // –ë–µ—Ä—ë–º –≤ —Ä–∞–±–æ—Ç—É (–∑–µ–ª—ë–Ω—ã–π)
        if (score >= 20) return 'badge-warning';      // –ö–∞–Ω–¥–∏–¥–∞—Ç –≤ —Ä–∞–±–æ—Ç—É (–∂—ë–ª—Ç—ã–π)
        if (score >= 8) return 'badge-info';          // –¢—Ä–µ–±—É–µ—Ç—Å—è Discovery (–≥–æ–ª—É–±–æ–π)
        return 'badge-error badge-outline';           // –ù–µ –±–µ—Ä—ë–º –≤ —Ä–∞–±–æ—Ç—É (–∫—Ä–∞—Å–Ω—ã–π outline)
    }

    async function updateRice(taskId, field, value) {
        try {
            // –î–ª—è budget_impact –∏—Å–ø–æ–ª—å–∑—É–µ–º parseFloat, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö parseInt
            const parsedValue = field === 'budget_impact'
                ? (value ? parseFloat(value) : null)
                : (value ? parseInt(value) : null);

            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [field]: parsedValue })
            });

            if (response.ok) {
                loadRiceTasks();
            }
        } catch (error) {
            console.error('Error updating Priority Score:', error);
        }
    }
</script>
{% endblock %}
